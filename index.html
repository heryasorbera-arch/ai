<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الرانيك (الدردشة)</title>
    <!-- تضمين Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* خط "Cairo" هو خط بديل جيد وواضح يدعم العربية بشكل جيد */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght400;700&display=swap');
        
        body {
            font-family: 'Cairo', sans-serif;
            direction: rtl; 
            /* خلفية غنية لتبدو احترافية */
            background-image: linear-gradient(to bottom right, #1a202c, #2d3748);
            background-attachment: fixed;
        }

        /* حاوية الدردشة - ارتفاع مرن */
        .chat-container {
            flex-grow: 1; /* جعلها تنمو لملء المساحة المتاحة */
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        /* ضبط ارتفاع الحاوية الرئيسية */
        .main-app-container {
            min-height: 95vh;
            max-width: 3xl;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            max-width: 85%;
        }

        /* تنسيق الجداول المتقدمة (لمطابقة طلب المستخدم) */
        .prose table {
            width: 100%;
            margin-top: 1rem;
            margin-bottom: 1rem;
            border-collapse: collapse;
            text-align: right;
            font-size: 0.9rem;
        }

        .prose th, .prose td {
            padding: 10px 15px;
            border: 1px solid #4a5568; /* حدود رمادية داكنة */
        }

        .prose thead th {
            background-color: #3182ce; /* لون أزرق جذاب للرؤوس */
            color: #ffffff;
            font-weight: bold;
        }

        .prose tbody tr:nth-child(even) {
            background-color: #2d3748; /* لون صفوف زوجية مختلف */
        }

        .prose strong {
            color: #4299e1; /* لون أزرق فاتح للنصوص الهامة */
        }

        /* تأثير تحميل بسيط */
        .loader {
            border-top-color: #63b3ed; /* أزرق فاتح */
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }

        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* زيادة الهامش بين الفقرات داخل فقاعات الرسائل لضمان الفصل الواضح */
        .message-bubble p {
            margin-bottom: 0.75rem; 
        }

        /* إزالة الهامش من آخر عنصر في الفقاعة لتجنب الفراغ الزائد */
        .message-bubble > div > p:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body class="text-gray-100 p-4 sm:p-8">

    <div class="main-app-container">
        
        <!-- العنوان الرئيسي وشريط التنقل -->
        <header class="text-center mb-6 bg-gray-900 p-4 rounded-xl shadow-2xl">
            <h1 class="text-4xl font-extrabold text-blue-400 mb-2">الرانيك</h1>
            <nav class="flex justify-center space-x-4 space-x-reverse">
                <button onclick="showView('chat')" id="chatTab" class="py-2 px-4 rounded-lg font-semibold bg-blue-600 hover:bg-blue-700 text-white transition duration-200">
                    وضع الدردشة
                </button>
                <button onclick="showView('commands')" id="commandsTab" class="py-2 px-4 rounded-lg font-semibold bg-gray-700 hover:bg-gray-600 text-gray-300 transition duration-200">
                    إدارة الأوامر المخصصة
                </button>
            </nav>
        </header>

        <!-- ************************************ -->
        <!-- 1. وضع الدردشة (CHAT VIEW) -->
        <!-- ************************************ -->
        <div id="chatView" class="flex flex-col flex-grow">
            <!-- منطقة المحادثة -->
            <div id="chatContainer" class="chat-container bg-gray-800 p-4 rounded-xl shadow-2xl mb-4">
                <!-- رسالة الترحيب الأولى من الذكاء الاصطناعي -->
                <div class="flex justify-start mb-4">
                    <div class="message-bubble bg-blue-700 text-white p-4 rounded-xl rounded-tr-none shadow-lg">
                        <p class="font-bold mb-1">المحاكي الفائق (AI):</p>
                        <p>مرحباً أيها القائد. أنا نظام محاكاة استراتيجي متقدم جداً. الأوامر الحالية توجهني لتقديم جداول متطورة وذكر الأدوات العسكرية الحقيقية كلها.</p>
                        <ol class="list-decimal list-inside mt-2 space-y-1">
                            <li>ابدأ بذكر الدولتين.</li>
                            <li>حدد سياق النزاع.</li>
                        </ol>
                        <p class="mt-2 text-sm italic opacity-80">لتحديد توجيهات صارمة جديدة، يرجى الانتقال إلى **"إدارة الأوامر المخصصة"**.</p>
                    </div>
                </div>
            </div>

            <!-- منطقة الإدخال والتحميل -->
            <div class="bg-gray-800 p-4 rounded-xl shadow-2xl flex items-center mt-auto">
                <input type="text" id="chatInput" onkeydown="if(event.keyCode===13) sendMessage()" class="flex-grow p-3 rounded-l-lg bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white placeholder-gray-500" placeholder="اكتب طلبك أو بيانات السيناريو هنا...">
                <button id="sendBtn" onclick="sendMessage()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-r-lg transition duration-300 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 flex items-center justify-center h-full">
                    <span id="buttonIcon">إرسال</span>
                    <div id="loadingIndicator" class="loader w-5 h-5 border-2 border-gray-200 border-solid rounded-full hidden mr-2" role="status"></div>
                </button>
            </div>
            
            <!-- رسالة الخطأ (تظهر هنا فقط) -->
            <p id="errorMsg" class="text-red-400 mt-2 text-center hidden text-sm"></p>

        </div> 
        <!-- نهاية وضع الدردشة -->

        <!-- ************************************ -->
        <!-- 2. صفحة إدارة الأوامر (COMMANDS VIEW) -->
        <!-- ************************************ -->
        <div id="commandsView" class="hidden flex-col flex-grow bg-gray-800 p-6 rounded-xl shadow-2xl">

            <h2 class="text-3xl font-extrabold text-yellow-400 mb-4 border-b border-gray-700 pb-2">لوحة التحكم الاستراتيجية</h2>
            
            <!-- API Key Configuration -->
            <h3 class="text-2xl font-semibold mb-3 text-gray-300 border-t border-gray-700 pt-4 mt-4">إعداد مفتاح API</h3>
            <div class="bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
                <div class="mb-4">
                    <label for="apiKeyInput" class="block text-sm font-medium text-gray-400 mb-1">مفتاح Gemini API الخاص بك</label>
                    <input type="password" id="apiKeyInput" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 text-white" placeholder="أدخل مفتاحك السري هنا">
                </div>
                <button id="saveApiKeyBtn" onclick="saveApiKey()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-300 mb-3">
                    حفظ مفتاح API وتفعيله
                </button>
                <div id="apiKeyStatus" class="text-center p-2 rounded text-sm font-medium"></div>
            </div>
            <!-- END API Key Configuration -->

            <!-- حالة الأمر النشط -->
            <div class="p-3 mb-6 rounded-lg bg-gray-700 border-l-4 border-yellow-500">
                <p class="text-lg font-semibold text-gray-200">الأمر النشط حالياً:</p> 
                <p class="text-xl text-yellow-400 mt-1 font-bold" id="activeCommandDisplay"></p>
                <p class="text-sm text-gray-400 italic mt-2">ملاحظة: النظام سيلتزم بهذه التعليمات **بصرامة 100%**.</p>
            </div>

            <h3 class="text-2xl font-semibold mb-3 text-gray-300">إضافة / تعديل أمر جديد:</h3>
            
            <!-- نموذج إضافة/تعديل الأمر -->
            <div class="bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
                <!-- إدخال اسم الأمر -->
                <div class="mb-4">
                    <label for="commandName" class="block text-sm font-medium text-gray-400 mb-1">اسم الأمر (لتحديده لاحقاً)</label>
                    <input type="text" id="commandName" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 text-white" placeholder="مثال: خبير التحليل السيبراني">
                </div>

                <!-- إدخال تعليمات النظام -->
                <div class="mb-4">
                    <label for="commandInstruction" class="block text-sm font-medium text-gray-400 mb-1">تعليمات النظام التفصيلية (ماذا يفعل الذكاء الاصطناعي)</label>
                    <textarea id="commandInstruction" rows="6" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 text-white" placeholder="يجب أن تتصرف كخبير في الحرب الإلكترونية، وتقدم جميع الإحصائيات في جداول..."></textarea>
                </div>
                
                <!-- زر الحفظ -->
                <button id="saveCommandBtn" onclick="saveNewCommand()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-300">
                    حفظ الأمر / تحديثه <span class="text-xs opacity-75">(يتم الحفظ محلياً)</span>
                </button>
            </div>
            
            <h3 class="text-2xl font-semibold mb-3 text-gray-300 border-t border-gray-700 pt-4">قائمة الأوامر المحفوظة:</h3>
            
            <!-- قائمة الأوامر المحفوظة -->
            <ul id="savedCommandsList" class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-grow overflow-y-auto">
                <!-- الأوامر ستظهر هنا -->
            </ul>
        </div>
        <!-- نهاية صفحة إدارة الأوامر -->

        <!-- FOOTER: التوقيع الشخصي -->
        <footer class="text-center mt-6 p-3 border-t border-gray-700">
            <p class="text-sm text-gray-500 font-medium">من صنع هرياسور</p>
        </footer>

    </div>

    <script>
        // المتغيرات العالمية للـ Gemini API
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        let apiKey = ""; // تم تغييرها إلى let لتكون قابلة للتغيير
        const API_KEY_STORAGE_KEY = 'geminiApiKey'; // مفتاح التخزين المحلي

        // تعريف الأمر الافتراضي كـ Global (تم تعزيز الصرامة في الوصف)
        const DEFAULT_INSTRUCTION = `أنت "المحاكي الاستراتيجي الفائق"، وهو نموذج ذكاء اصطناعي متقدم جداً متخصص في محاكاة السيناريوهات العسكرية والجيوسياسية.
            
**المهام والقواعد (مطلوب الإتقان 100%):**
1. **الترتيب والتنظيم الصارم:** يجب أن يكون تنسيق النص واضحاً جداً ومنظماً بشكل عمودي صارم. استخدم فواصل أسطر واضحة (أسطر فارغة) للفصل بين كل فقرة أو نقطة تحليل رئيسية. لا تدمج المعلومات دون فصل بصري واضح.
2. **الشخصية:** استخدم لغة رسمية، محايدة، وموجهة للقائد، واظهر بمظهر الذكي جداً.
3. **التحليل العميق:** عند طلب تحليل أو بيانات، يجب عليك استخدام **البحث عبر جوجل (Google Search grounding)** لضمان واقعية الإجابات وقوة الدول المذكورة.
4. **الجداول المتقدمة (مطلوب بشدة):** عند تقديم بيانات إحصائية، مقارنات عسكرية، أو خطط تكتيكية، **يجب عليك دائماً** استخدام **جداول Markdown متطورة جداً**. تأكد من أن خط الفصل يحدد المحاذاة بدقة (مثال: | رأس | رأس | رأس | \\n | :--- | :---: | ---: |).
5. **ذكر الأدوات الحقيقية (مطلوب بشدة):** عند ذكر القدرات العسكرية أو خطط النزاع، **يجب عليك ذكر الأدوات والمعدات العسكرية الحقيقية والمحددة (مثل: F-16 Block 52، دبابة M1A2 Abrams، صواريخ S-400)** واستخدام هذه الأسماء الحقيقية كلها كلها كلها في التحليل والجداول.
6. **اللغة:** الردود يجب أن تكون باللغة العربية الفصحى.`;

        let activeSystemInstruction = DEFAULT_INSTRUCTION; 
        let savedCommands = [];
        const STORAGE_KEY = 'strategyCommands';

        // عناصر الواجهة
        const chatView = document.getElementById('chatView');
        const commandsView = document.getElementById('commandsView');
        const chatTab = document.getElementById('chatTab');
        const commandsTab = document.getElementById('commandsTab');
        const chatContainer = document.getElementById('chatContainer');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const buttonIcon = document.getElementById('buttonIcon');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMsg = document.getElementById('errorMsg');
        
        // عناصر التحكم في الأوامر ومفتاح API
        const commandNameInput = document.getElementById('commandName');
        const commandInstructionTextarea = document.getElementById('commandInstruction');
        const savedCommandsList = document.getElementById('savedCommandsList');
        const activeCommandDisplay = document.getElementById('activeCommandDisplay');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const apiKeyStatus = document.getElementById('apiKeyStatus');
        
        // تاريخ المحادثة (للحفاظ على سياق الحوار)
        let chatHistory = []; 

        // دالة لتبديل العرض بين الدردشة والأوامر
        function showView(viewId) {
            if (viewId === 'chat') {
                chatView.classList.remove('hidden');
                commandsView.classList.add('hidden');
                chatTab.classList.replace('bg-gray-700', 'bg-blue-600');
                chatTab.classList.replace('text-gray-300', 'text-white');
                commandsTab.classList.replace('bg-blue-600', 'bg-gray-700');
                commandsTab.classList.replace('text-white', 'text-gray-300');
                // التركيز على حقل الإدخال عند العودة للدردشة
                chatInput.focus(); 
            } else {
                chatView.classList.add('hidden');
                commandsView.classList.remove('hidden');
                commandsTab.classList.replace('bg-gray-700', 'bg-blue-600');
                commandsTab.classList.replace('text-gray-300', 'text-white');
                chatTab.classList.replace('bg-blue-600', 'bg-gray-700');
                chatTab.classList.replace('text-white', 'text-gray-300');
            }
        }

        // دالة لعرض التنبيهات المخصصة (بدلاً من alert)
        function showCustomAlert(message, type) {
            const bar = document.createElement('div');
            bar.textContent = message;
            bar.className = 'fixed top-0 right-0 p-3 m-4 rounded-lg shadow-xl text-white z-50 transition-transform duration-300 transform translate-x-full';
            
            if (type === 'success') {
                bar.classList.add('bg-green-600', 'translate-x-0');
            } else if (type === 'error') {
                bar.classList.add('bg-red-600', 'translate-x-0');
            } else { // info
                bar.classList.add('bg-blue-600', 'translate-x-0');
            }
            
            document.body.appendChild(bar);
            
            setTimeout(() => {
                bar.classList.remove('translate-x-0');
                bar.classList.add('translate-x-full');
                setTimeout(() => bar.remove(), 300);
            }, 3000);
        }

        // --- وظائف إدارة الأوامر المحلية ---

        function saveCommandsToLocal() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(savedCommands));
            } catch (e) {
                console.error("Could not save commands to localStorage:", e);
                showCustomAlert('عفواً، فشل حفظ الأوامر محلياً.', 'error');
            }
        }

        function loadCommands() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    savedCommands = JSON.parse(stored);
                }
            } catch (e) {
                console.error("Could not load commands from localStorage:", e);
            }
            renderCommands();
        }

        function setActiveInstruction(instruction, name) {
            activeSystemInstruction = instruction;
            activeCommandDisplay.textContent = name;
            
            // إزالة تحديد الكل وإضافة تحديد للعنصر النشط
            document.querySelectorAll('.command-item').forEach(el => el.classList.remove('ring-2', 'ring-blue-400', 'bg-blue-900/50'));
            
            // نستخدم دالة للتخلص من الأحرف التي قد تسبب مشاكل في الـ ID
            const safeName = encodeURIComponent(name).replace(/%/g, 'p'); 
            const activeElement = document.getElementById(`cmd-${safeName}`);
            if (activeElement) {
                activeElement.classList.add('ring-2', 'ring-blue-400', 'bg-blue-900/50');
            }
            showCustomAlert(`تم تفعيل الأمر: ${name} (إتقان 100%)`, 'info');
        }

        function saveNewCommand() {
            const name = commandNameInput.value.trim();
            const instruction = commandInstructionTextarea.value.trim();

            if (!name || !instruction) {
                showCustomAlert('يرجى ملء اسم الأمر والتعليمات.', 'error');
                return;
            }

            const existsIndex = savedCommands.findIndex(cmd => cmd.name === name);
            if (existsIndex > -1) {
                // Update existing command
                savedCommands[existsIndex] = { name, instruction };
            } else {
                // Add new command
                savedCommands.push({ name, instruction });
            }

            saveCommandsToLocal();
            renderCommands();
            commandNameInput.value = '';
            commandInstructionTextarea.value = '';
            showCustomAlert('تم حفظ الأمر بنجاح.', 'success');
        }

        function deleteCommand(name) {
            savedCommands = savedCommands.filter(cmd => cmd.name !== name);
            saveCommandsToLocal();
            renderCommands();
            
            // إذا كان الأمر المحذوف هو الأمر النشط، نعود إلى الأمر الافتراضي
            if (activeCommandDisplay.textContent === name) {
                setActiveInstruction(DEFAULT_INSTRUCTION, 'النظام الافتراضي (صيغة صارمة: يجب الإتقان 100%)');
            }
            showCustomAlert('تم حذف الأمر.', 'info');
        }

        function renderCommands() {
            savedCommandsList.innerHTML = '';
            const activeName = activeCommandDisplay.textContent || 'النظام الافتراضي (صيغة صارمة: يجب الإتقان 100%)';
            
            // 1. إضافة الأمر الافتراضي
            const defaultName = 'النظام الافتراضي (صيغة صارمة: يجب الإتقان 100%)';
            const defaultLi = document.createElement('li');
            defaultLi.className = 'command-item cursor-pointer p-4 rounded-xl transition duration-150 ease-in-out hover:bg-gray-700/70 border border-gray-600/50 shadow-md';
            defaultLi.id = `cmd-${encodeURIComponent(defaultName).replace(/%/g, 'p')}`;
            defaultLi.onclick = () => setActiveInstruction(DEFAULT_INSTRUCTION, defaultName);
            defaultLi.innerHTML = `
                <p class="font-bold text-blue-300 text-xl">${defaultName}</p>
                <p class="text-sm text-gray-400 mt-1">القواعد الأصلية التي تضمن جداول متطورة وذكر الأدوات الحقيقية والترتيب العمودي الصارم.</p>
            `;
            savedCommandsList.appendChild(defaultLi);

            // 2. إضافة الأوامر المحفوظة
            savedCommands.forEach(cmd => {
                const li = document.createElement('li');
                li.className = 'command-item p-4 rounded-xl transition duration-150 ease-in-out hover:bg-gray-700/70 border border-gray-600/50 shadow-md';
                li.id = `cmd-${encodeURIComponent(cmd.name).replace(/%/g, 'p')}`;
                // استخدام encode/decodeURIComponent لضمان سلامة الإرسال في onclick
                li.innerHTML = `
                    <div class="flex justify-between items-start">
                        <span class="font-bold text-gray-200 text-xl cursor-pointer" onclick="setActiveInstruction(decodeURIComponent('${encodeURIComponent(cmd.instruction)}'), '${cmd.name}')">${cmd.name}</span>
                        <button onclick="deleteCommand('${cmd.name}')" class="text-red-400 hover:text-red-600 transition duration-150 ease-in-out text-sm p-1 rounded-full bg-gray-700/50">حذف</button>
                    </div>
                    <p class="text-sm text-gray-400 mt-1 line-clamp-2">${cmd.instruction}</p>
                `;
                savedCommandsList.appendChild(li);
            });
            
            // 3. تحديد الأمر النشط
            setActiveInstruction(activeSystemInstruction, activeName);
        }

        // --- وظائف إدارة مفتاح API محلياً ---

        function updateApiKeyStatus(hasKey, message = null) {
            if (hasKey) {
                apiKeyStatus.className = 'text-center p-2 rounded text-sm font-medium bg-green-900 text-green-300';
                apiKeyStatus.textContent = message || 'المفتاح محمل وجاهز للاستخدام.';
            } else {
                apiKeyStatus.className = 'text-center p-2 rounded text-sm font-medium bg-red-900 text-red-300';
                apiKeyStatus.textContent = message || 'لا يوجد مفتاح API نشط. لن يعمل المحاكي.';
            }
        }
        
        function loadApiKey() {
            try {
                const storedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
                if (storedKey) {
                    apiKey = storedKey;
                    updateApiKeyStatus(true);
                    return true;
                }
            } catch (e) {
                console.error("Could not load API key from localStorage:", e);
                updateApiKeyStatus(false, 'فشل في تحميل المفتاح من التخزين المحلي.');
            }
            updateApiKeyStatus(false);
            return false;
        }

        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (!key) {
                showCustomAlert('يرجى إدخال مفتاح API أولاً.', 'error');
                return;
            }
            
            try {
                localStorage.setItem(API_KEY_STORAGE_KEY, key);
                apiKey = key;
                apiKeyInput.value = ''; // مسح الإدخال بعد الحفظ
                updateApiKeyStatus(true, 'تم حفظ وتفعيل مفتاح API بنجاح.');
                showCustomAlert('تم حفظ وتفعيل مفتاح API بنجاح.', 'success');
            } catch (e) {
                console.error("Could not save API key to localStorage:", e);
                updateApiKeyStatus(false, 'فشل في حفظ المفتاح.');
                showCustomAlert('عفواً، فشل حفظ المفتاح محلياً.', 'error');
            }
        }


        // --- وظائف عرض المحادثة والـ API ---

        // إضافة رسالة للدردشة
        function addMessage(role, text) {
            const isUser = role === 'user';
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex mb-4 ${isUser ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `message-bubble p-4 rounded-xl shadow-lg ${isUser 
                ? 'bg-blue-500 text-white rounded-tl-none' 
                : 'bg-gray-700 text-gray-100 rounded-tr-none'}`;
            
            const content = document.createElement('div');
            // نستخدم div بدلاً من p هنا إذا كنا سنقوم بالمعالجة داخل markdownToHtml
            content.innerHTML = isUser ? `<p>${text}</p>` : `<p class="font-bold mb-1 text-blue-400">المحاكي الفائق (AI):</p>` + markdownToHtml(text);
            
            bubble.appendChild(content);
            messageDiv.appendChild(bubble);
            chatContainer.appendChild(messageDiv);
            
            // التمرير التلقائي لأسفل
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        /**
         * دالة تحويل نص Markdown إلى HTML مع دعم محدود للجداول.
         */
        function markdownToHtml(markdownText) {
            let html = markdownText;

            // --- Basic Markdown Table Support (Header | Separator | Rows)
            // نستخدم مطابقة أكثر دقة لصف الفصل لتفادي المشاكل
            const tableRegex = /((?:\|.*\|\r?\n)(?:\|[\s:-]+?\|.*\r?\n)(?:\|.*\|\r?\n?)+)/gm;
            html = html.replace(tableRegex, (match) => {
                const lines = match.trim().split('\n').map(line => line.trim());
                if (lines.length < 2) return match;

                const headerLine = lines[0].split('|').slice(1, -1).map(h => `<th>${h.trim()}</th>`).join('');
                let bodyHtml = '';
                
                // نبدأ من السطر 2 (بعد العنوان وخط الفصل)
                for (let i = 2; i < lines.length; i++) {
                    const rowCells = lines[i].split('|').slice(1, -1).map(c => `<td>${c.trim()}</td>`).join('');
                    if (rowCells) {
                        bodyHtml += `<tr>${rowCells}</tr>`;
                    }
                }
                
                return `<div class="overflow-x-auto my-4"><table class="prose w-full text-sm text-right rtl:text-right text-gray-400">
                    <thead><tr>${headerLine}</tr></thead>
                    <tbody>${bodyHtml}</tbody></table></div>`;
            });
            // --- End Table Support

            // استبدال العناوين (##)
            html = html.replace(/^## (.*$)/gim, '<h3>$1</h3>');
            // استبدال العناوين (#)
            html = html.replace(/^# (.*$)/gim, '<h2>$1</h2>');
            
            // تنسيق النصوص الغامقة (Bold)
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // استبدال القوائم غير المرتبة (*) أو (-)
            html = html.replace(/^\* (.*$)/gim, '<li>$1</li>');
            html = html.replace(/^- (.*$)/gim, '<li>$1</li>');
            
            // إضافة وسم <ul> حول القوائم
            html = html.replace(/(<li>.*<\/li>)/gms, '<ul>$1</ul>');
            
            // الفقرات - إضافة وسم <p> حول النص الذي ليس وسم HTML
            // هنا يكمن سر الترتيب: سيتم تحويل كل سطرين فارغين متتاليين إلى فقرة P منفصلة، مما يضمن وجود فواصل
            html = html.split('\n\n').map(segment => {
                if (!segment.trim()) return '';
                if (segment.match(/^<h|<ul|<li|<div|^\s*\|/im)) {
                    // إذا كان العنصر جدولاً أو عنواناً أو قائمة، لا نضعه داخل <p>
                    return segment;
                }
                // تطبيق تنسيق Bold و Italics قبل وضعها في P
                let formattedSegment = segment.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                formattedSegment = formattedSegment.replace(/\*(.*?)\*/g, '<em>$1</em>');
                return `<p>${formattedSegment.trim()}</p>`;
            }).join('\n');

            // إزالة وسم p الذي يحيط بالعناوين أو القوائم أو الجداول بشكل خاطئ
            html = html.replace(/<p>(<h[234]>.*<\/h[234]>)<\/p>/gim, '$1');
            html = html.replace(/<p>(<ul>.*<\/ul>)<\/p>/gims, '$1');
            html = html.replace(/<p>(<div.*<\/div>)<\/p>/gims, '$1');
            
            return html;
        }


        /**
         * دالة تنفيذ طلب توليد المحادثة عبر Gemini API مع المحافظة على السياق.
         */
        async function fetchGeminiChatResponse() {
            
            // التأكد من وجود مفتاح API قبل المتابعة
            if (!apiKey) {
                throw new Error("API Key is missing. Please enter your key in the 'إدارة الأوامر المخصصة' section.");
            }

            // استخدام activeSystemInstruction (التي يختارها المستخدم)
            const systemInstruction = activeSystemInstruction; 

            const payload = {
                contents: chatHistory, // إرسال تاريخ المحادثة بالكامل للحفاظ على السياق
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                },
            };

            // تنفيذ سياسة Backoff عند فشل الاتصال
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(GEMINI_API_URL + apiKey, { // استخدام متغير apiKey
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status !== 429 && response.status !== 500) {
                             throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        if (i === 4) throw new Error("API failed after multiple retries.");
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                        continue;
                    }
                    
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!text) {
                         throw new Error("Received empty response from API.");
                    }
                    
                    return text;

                } catch (error) {
                    if (i === 4) throw error;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
            throw new Error("Failed to generate content after all retries.");
        }


        /**
         * الدالة الرئيسية لإرسال الرسالة.
         */
        async function sendMessage() {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            // إظهار رسالة المستخدم
            addMessage('user', userMessage);
            
            // إضافة الرسالة إلى سجل المحادثة
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

            // تصفير حقل الإدخال
            chatInput.value = '';
            errorMsg.classList.add('hidden');

            // إظهار حالة التحميل
            sendBtn.disabled = true;
            buttonIcon.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');

            try {
                const aiResponseText = await fetchGeminiChatResponse();
                
                // إضافة رد الذكاء الاصطناعي إلى سجل المحادثة والواجهة
                chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });
                addMessage('model', aiResponseText);

            } catch (error) {
                console.error("Gemini API Error:", error);
                // رسالة خطأ واضحة للمستخدم
                if (error.message.includes("API Key is missing")) {
                    errorMsg.textContent = "يرجى إدخال مفتاح API في قسم 'إدارة الأوامر المخصصة' للمتابعة.";
                } else {
                    errorMsg.textContent = `عفواً، فشل في الرد. (الخطأ: ${error.message})`;
                }
                errorMsg.classList.remove('hidden');
                // في حالة الخطأ، من الأفضل إزالة آخر رسالة للمستخدم لتجنب السياق الخاطئ
                chatHistory.pop(); 
            } finally {
                // إخفاء حالة التحميل وإعادة تفعيل الزر
                sendBtn.disabled = false;
                buttonIcon.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
                chatInput.focus();
            }
        }
        
        // --- تهيئة التطبيق ---
        function initializeApp() {
            loadCommands();
            loadApiKey(); // تحميل مفتاح API عند بدء التشغيل
            // تفعيل الأمر الافتراضي عند التحميل
            setActiveInstruction(DEFAULT_INSTRUCTION, 'النظام الافتراضي (صيغة صارمة: يجب الإتقان 100%)');
            // عرض وضع الدردشة افتراضياً
            showView('chat');
        }

        initializeApp();

    </script>
</body>
</html>
